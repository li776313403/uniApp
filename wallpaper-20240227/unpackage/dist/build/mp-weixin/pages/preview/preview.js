"use strict";const e=require("../../common/vendor.js"),a=require("../../stores/layoutStore.js"),t=require("../../stores/dataStore.js"),l=require("../../api/wallpaper.js"),o=require("../../unit/basicData.js"),n=require("../../unit/queryAndParamHelper.js"),i=require("../../unit/otherHelper.js");if(require("../../unit/request.js"),!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-dateformat")+e.resolveComponent("uni-rate")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-dateformat/components/uni-dateformat/uni-dateformat.js")+(()=>"../../uni_modules/uni-rate/components/uni-rate/uni-rate.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const s=e.defineComponent({__name:"preview",setup(s){const u=a.useLayoutStore(),r=t.useDataStore(),d=e.ref(!0),c=e.ref(Date.now()),v={date:null},p=e.ref(),h=e.ref(),m=e.computed((()=>u.statusBarHeight||15)),g=e.computed((()=>u.dy_TitleLeftIconDistance)),f=e.computed({get:()=>r.classify,set:e=>r.setClassifyData(e)}),w=e.computed({get:()=>r.wall.map((e=>(e.picurl=e.smallPicurl.replace("_small.webp",".jpg"),e))),set:e=>r.setWallData(e)}),x=e.ref({wallId:"",classId:""}),y=e.computed((()=>n.queryAndParamHelper.tansParams(x.value))),I=e.ref(-1),_=e.ref([]),S=e.computed((()=>w.value[I.value])),T=e.ref(0),b=e.computed((()=>S.value.userScore?S.value.userScore:S.value.score)),L=e.computed((()=>{const e=f.value.filter((e=>e._id===x.value.classId));return e.length>0?e[0].name:"未知分类"})),j=e.ref({classid:"",pageNum:1,pageSize:12}),q=e=>{let a=[];return a=0===e?[w.value.length-1,e,e+1]:e===w.value.length-1?[e-1,e,0]:[e-1,e,e+1],a},D=()=>{d.value=!d.value},H=()=>{p.value.open()},P=()=>{p.value.close()},C=()=>{h.value.open()},M=()=>{h.value.close()},k=()=>{e.index.showLoading({title:"提交评分中..."});const a={classid:S.value.classid,wallId:S.value._id,userScore:T.value};l.setupSocre(a).then((a=>{0===a.errCode?e.index.showToast({title:"评分成功",icon:"success"}).finally((()=>{const e=JSON.parse(JSON.stringify(w.value)),a=JSON.parse(JSON.stringify(S.value));a.score=T.value,e[I.value]=a,r.setWallData(e),M()})):(e.index.showToast({title:"评分失败",icon:"error"}),console.error("评分失败",a.errMsg))})).catch((a=>{e.index.showToast({title:"评分失败",icon:"error"}),console.error("评分失败",a)})).finally((()=>{e.index.hideLoading()}))},z=()=>{e.index.navigateBack().catch((()=>{x.value.wallId="",e.index.redirectTo({url:"/pages/classList/classList?"+y.value})}))},A=e=>{I.value=e.detail.current;const a=q(I.value).filter((e=>!_.value.includes(e)));a.length>0&&(_.value=_.value.concat(a))},N=e=>{T.value=e.show?b.value:0},$=async()=>{try{e.index.showLoading({title:"下载中...",mask:!0});const a=await l.getDownloadWall({classid:S.value.classid,wallId:S.value._id});if(0===a.errCode){const a=await e.index.getImageInfo({src:S.value.picurl});await e.index.saveImageToPhotosAlbum({filePath:a.path}),e.index.showToast({icon:"success",title:"壁纸已保存到相册"}).finally((()=>{e.index.hideLoading()}))}else e.index.hideLoading(),e.index.showToast({icon:"none",title:a.errMsg})}catch(a){e.index.hideLoading();const t=a;if(t.errMsg)if(t.errMsg.includes("saveImageToPhotosAlbum:fail auth deny")){const a=await e.index.showModal({title:"提示",content:"需要授权保存到相册"});a.confirm?e.index.openSetting({success:a=>{a.authSetting["scope.writePhotosAlbum"]?e.index.showToast({icon:"success",title:"保存相册授权成功"}):e.index.showToast({icon:"none",title:"保存相册授权失败"})}}):a.cancel&&e.index.showToast({title:"授权已取消"})}else t.errMsg.includes("saveImageToPhotosAlbum:fail cancel")&&e.index.showToast({icon:"none",title:"已取消保存"})}},J=()=>{e.index.showLoading({title:"壁纸数据加载中..."}),j.value.classid=x.value.classId,l.getWall(j.value).then((a=>{if(0===a.errCode){const t=w.value.map((e=>e._id)),l=a.data.filter((e=>!t.includes(e._id)));w.value=w.value.concat(l);const o=j.value.pageSize===a.data.length;x.value.wallId&&(o?w.value.some((e=>e._id===x.value.wallId))?(I.value=w.value.findIndex((e=>e._id===x.value.wallId)),_.value=_.value.concat(q(I.value))):(j.value.pageNum++,J()):e.index.showToast({icon:"none",title:"未找到当前壁纸,即将跳转到首页"}).then((()=>{i.otherHelper.goIndex()})))}else e.index.showToast({title:"未找到当前壁纸,即将跳转到首页",icon:"none"}).then((()=>{i.otherHelper.goIndex()}))})).catch((()=>{e.index.showToast({title:"未找到当前壁纸,即将跳转到首页",icon:"none"}).then((()=>{i.otherHelper.goIndex()}))})).finally((()=>{e.index.hideLoading()}))};return e.onLoad((a=>{x.value=a,w.value.length>0?(I.value=w.value.findIndex((e=>e._id===x.value.wallId)),_.value=_.value.concat(q(I.value))):(e.index.showLoading({title:"分类数据加载中..."}),l.getClassify({select:!1,pageNum:1,pageSize:100}).then((a=>{0===a.errCode?(f.value=a.data.sort((e=>e.sort)),f.value.filter((e=>e._id===x.value.classId))?J():e.index.showToast({title:"获取壁纸分类数据失败,即将跳转到首页",icon:"none"}).then((()=>{i.otherHelper.goIndex()}))):e.index.showToast({title:"获取壁纸分类数据失败,即将跳转到首页",icon:"none"}).then((()=>{i.otherHelper.goIndex()}))})).catch((()=>{e.index.showToast({title:"获取壁纸分类数据失败,即将跳转到首页",icon:"none"}).then((()=>{i.otherHelper.goIndex()}))})).finally((()=>{e.index.hideLoading()})))})),e.onShow((()=>{c.value=Date.now(),v.date=setInterval((()=>{c.value=Date.now()}),1e3)})),e.onHide((()=>{v.date&&clearInterval(v.date)})),e.onShareAppMessage((()=>({title:`${o.basicData.title}-${L.value}-${S.value._id}`,path:"/pages/preview/preview?"+y.value}))),e.onShareTimeline((()=>({title:`${o.basicData.title}-${L.value}-${S.value._id}`,query:y.value}))),(a,t)=>e.e({a:-1!==I.value},-1!==I.value?{b:e.f(w.value,((a,t,l)=>e.e({a:_.value.includes(t)},_.value.includes(t)?{b:a.picurl,c:e.o(D,a._id)}:{},{d:a._id}))),c:I.value,d:e.o(A),e:e.p({type:"back",size:"20"}),f:e.o(z),g:m.value+"px",h:g.value+"px",i:e.t(I.value+1),j:e.t(w.value.length),k:e.p({date:c.value,format:"hh : mm"}),l:e.p({date:c.value,format:"MM月dd日"}),m:e.p({type:"info",size:"28"}),n:e.o(H),o:e.p({type:S.value.userScore?"star-filled":"star",size:"28"}),p:e.t(b.value),q:e.o(C),r:e.p({type:"download",size:"28"}),s:e.o($),t:d.value,v:e.p({type:"closeempty",size:"18"}),w:e.o(P),x:e.t(S.value._id),y:e.t(L.value),z:e.t(S.value.nickname),A:e.p({value:b.value,readonly:!0,"allow-half":!0,touchable:!1}),B:e.t(b.value),C:e.t(S.value.description),D:e.f(S.value.tabs,((a,t,l)=>({a:e.t(a),b:a}))),E:e.sr(p,"71dcd69d-6",{k:"infoPanlRef"}),F:e.p({type:"bottom"}),G:e.p({type:"closeempty",size:"18"}),H:e.o(M),I:e.o((e=>T.value=e)),J:e.p({"allow-half":!0,touchable:!0,readonly:S.value.userScore,modelValue:T.value}),K:e.t(T.value),L:e.t(S.value.userScore?"已评分":"提交评分"),M:e.o(k),N:0===T.value||S.value.userScore,O:e.sr(h,"71dcd69d-9",{k:"ratePanlRef"}),P:e.o(N),Q:e.p({type:"center","is-mask-click":!1})}:{})}});s.__runtimeHooks=6;const u=e._export_sfc(s,[["__scopeId","data-v-71dcd69d"]]);wx.createPage(u);
